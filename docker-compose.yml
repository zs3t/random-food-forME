# ================================
# Random Food 全栈应用部署配置
# ================================
# 包含：
# - frontend: Next.js 前端服务
# - backend: Express.js 后端 API 服务
# ================================

services:
  # ================================
  # 后端服务 (Express + SQLite)
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: random-food-backend
    restart: unless-stopped

    environment:
      - NODE_ENV=production
      - BACKEND_HOST=${BACKEND_HOST:-0.0.0.0}
      - BACKEND_PORT=9091
      - DB_PATH=/app/data/food_db.sqlite

    ports:
      - "127.0.0.1:${BACKEND_PORT:-9091}:9091"

    volumes:
      # SQLite 数据库持久化到宿主机
      - ./data:/app/data
      # 日志持久化
      - ./logs/backend:/app/logs

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9091/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - random-food-network

  # ================================
  # 前端服务 (Next.js)
  # ================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BACKEND_HOST: backend
        BACKEND_PORT: 9091

    container_name: random-food-frontend
    restart: unless-stopped

    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=/api/backend
      - BACKEND_HOST=backend
      - BACKEND_PORT=9091

    ports:
      - "127.0.0.1:${FRONTEND_PORT:-9090}:9090"

    depends_on:
      backend:
        condition: service_healthy

    networks:
      - random-food-network

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:9090/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ================================
# 网络配置
# ================================
networks:
  random-food-network:
    driver: bridge

# ================================
# 数据卷配置（可选）
# ================================
# 如果需要使用命名卷而不是绑定挂载，可以启用以下配置：
# volumes:
#   sqlite-data:
#     driver: local
#   backend-logs:
#     driver: local
#
# 然后修改 backend 服务的 volumes：
# volumes:
#   - sqlite-data:/app/food_db.sqlite
#   - backend-logs:/app/logs
